---
title: "Examples With Peak Finder Script"
author: "Michael Olvera"
date: "September 8, 2016"
output:
  html_document: default
  pdf_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Using Peak Finder

This is a quick guide on how to use the Peak Finder script. Feel free to follow along with the code in this file to make sure everything is working well. For this file, R code is in boxes, and outputs are boxes with **##** before the code.

Before starting, include the following line of code at the top
of your script:

```{r source}
source("R/peakFinder.R")
```

## Loading data straight from the microscope.

Data from a Ziess experiment incudes several metrics we are not interested in, as well as artifacts introduced by loading the data into R. Here is an example of raw data from the Ziess:

```{r loading1}
raw_data <- read.csv(file = "./data/CMEC_75.25-1_5.16.17_1.csv")
colnames(raw_data) <- NULL
head(raw_data)
```

PeakFinder has a build in function to automatically clean the data, leaving only the mean intensity values. 

```{r loading2}
raw_data <- readZiessData(path_to_csv = "./data/CMEC_75.25-1_5.16.17_1.csv", time_index = 1, grep_keyword = "IntensityMean")
colnames(raw_data) <- NULL
head(raw_data)
```

Note that I am nullifying the column names for printing purposes only. You do not nulify column names normally, and you are recommended to change column names after running *readZiessData()*.

## Quick Introduction

For simplicity's sake, I will be loading in another preprocessed dataframe. Samples must be preprocessed to be a dataframe with **Time**
included, and all other columns the mean intensity values of samples. A preprocessed dataset is included in the zip folder:

```{r exampleData}
example <- read.csv('data/CaHandUT1.csv')
head(example) # Prints first 6 rows
```

As a side note, make sure all of your comlumes are numeric/integers. A common mistake with R is that .csv files are loaded with columns being factors. 

```{r exampleData2}
str(example)
```

As you can see above, all columns are of **type** numeric (**num**). Looking a the second row of the output, *$ Time* indicates the title of the column, then the datatype, followed by the first few data entries. 

To analyze data, I have written a function to wrap the data in an object called *dataframeToExperiment()*. The 'experiment' object will hold all the intensity values, the time measurments, and all the computed readings. 

```{r exampleObject1}
example.object <- dataframeToExperiment(dataframe =  example, timeIndex = 1)

print(example.object)
```

When the object is created, it will run a full test to try and detect errors in the data. Some errors will be patched automatically, while others might have to be excluded from further analysis. 

## Analysis

The main functions are *analyzeExperiemnt()* and *runTestGraph()*. You can call *analyzerExperiment()* on you experiment object to get physiologically relivant data, including:
- Beats per minute
- Amplitute
- Upstroke and Downstroke T50
- Vmax (Up and Decay)

```{r runTest1}
example.object <- analyzeExperiment(example.object)
head(example.object$results)
```

Individual readings can be called to a ploting funciton, for closer inspection of where the progrmaing is calling peaks, minimum values, etc. *runTestGraph()* can be called on the names of individual reading, or on the whole dataset (if the second argument is left blank).

```{r runTest2}
runTestGraph(example.object, c("R2", "R6"))
```

The output can be saved and extracted to be used in Excel/Prism. 

```{r eval=F}

write.csv(example.object$results, "~/Desktop/results.csv")
```

If you have any questions or bugs, please let me know (michael.olvera@gladstone.ucsf.edu).

```{r end}
sessionInfo() 
```
